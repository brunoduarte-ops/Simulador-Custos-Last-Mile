<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Custos - Last Mile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease-in-out;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            color: #475569;
        }
        .slider-value {
            font-weight: 600;
            color: #1e293b;
            background-color: #f1f5f9;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            min-width: 60px;
            text-align: center;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        input[type="range"]:hover {
            opacity: 1;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #ca8a04;
            cursor: pointer;
            border-radius: 50%;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #ca8a04;
            cursor: pointer;
            border-radius: 50%;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 450px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 50vh;
            }
        }
        .disabled-overlay {
            position: relative;
        }
        .disabled-overlay::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 250, 252, 0.7);
            cursor: not-allowed;
            z-index: 10;
        }
        .disabled-overlay label, .disabled-overlay input {
            cursor: not-allowed;
        }
    </style>
</head>
<body class="text-slate-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Simulador de Custos - Last Mile</h1>
            <p class="mt-2 text-lg text-slate-600">Ajuste os parâmetros para encontrar o ponto de equilíbrio e otimizar sua operação.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <aside class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-1 text-slate-900">Parâmetros da Operação</h2>
                <p class="text-sm text-slate-500 mb-6">Utilize os controles deslizantes e os campos de texto para testar diferentes cenários operacionais e financeiros. As mudanças serão refletidas instantaneamente nos resultados ao lado.</p>

                <div id="input-form" class="space-y-6">
                    
                    <div>
                        <h3 class="font-semibold text-slate-700 border-b pb-2 mb-3">Estrutura e Volume</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="diasUteis" class="slider-label"><span>Dias úteis / mês</span><span class="slider-value" id="diasUteisValue">22</span></label>
                                <input type="range" id="diasUteis" min="1" max="31" value="22" class="w-full">
                            </div>
                            <div>
                                <label for="pedidosPorEntregador" class="slider-label"><span>Pedidos por entregador / dia</span><span class="slider-value" id="pedidosPorEntregadorValue">18</span></label>
                                <input type="range" id="pedidosPorEntregador" min="1" max="100" value="18" class="w-full">
                            </div>
                             <div>
                                <label for="volumetriaTotal" class="block text-sm font-medium text-slate-600 mb-1">Volumetria total de pedidos / mês</label>
                                <input type="number" id="volumetriaTotal" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="Ex: 1000" value="1000" min="0">
                            </div>
                             <div>
                                <label for="kmPorEntrega" class="slider-label"><span>Média de km / entrega</span><span class="slider-value" id="kmPorEntregaValue">5</span></label>
                                <input type="range" id="kmPorEntrega" min="1" max="50" value="5" class="w-full">
                            </div>
                            <div>
                                <label for="velocidadeMedia" class="block text-sm font-medium text-slate-600 mb-1">Velocidade média por km rodado (km/h)</label>
                                <input type="number" id="velocidadeMedia" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="Ex: 20" value="20" min="0">
                            </div>
                        </div>
                    </div>

                    <div id="minWageSection">
                         <h3 class="font-semibold text-slate-700 border-b pb-2 mb-3">Condições de Remuneração</h3>
                         <div class="space-y-4">
                            <div>
                                <label for="salarioMinimoDiarioSlider" class="slider-label"><span>Salário Mínimo Diário Esperado (R$)</span><span class="slider-value" id="salarioMinimoDiarioSliderValue">0.00</span></label>
                                <input type="range" id="salarioMinimoDiarioSlider" min="0" max="300" value="0" step="5" class="w-full">
                                <p class="text-xs text-slate-400 mt-2">Se um valor for selecionado, este será o custo diário, ignorando o modelo de pagamento.</p>
                            </div>
                         </div>
                    </div>

                    <div id="paymentSection">
                        <h3 class="font-semibold text-slate-700 border-b pb-2 mb-3">Custos e Pagamento</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="font-medium text-sm text-slate-600">Modelo de Pagamento atual ao Entregador</label>
                                <div class="flex items-center space-x-4 mt-2 text-sm">
                                    <label><input type="radio" name="paymentModel" value="km" class="mr-1"> R$/km</label>
                                    <label><input type="radio" name="paymentModel" value="diaria" checked class="mr-1"> R$/diária</label>
                                    <label><input type="radio" name="paymentModel" value="pedido" class="mr-1"> R$/pedido</label>
                                </div>
                            </div>
                             <div>
                                <label for="valorKm" class="slider-label"><span>Valor por km rodado (R$)</span><span class="slider-value" id="valorKmValue">2.50</span></label>
                                <input type="range" id="valorKm" min="0.1" max="10" value="2.5" step="0.1" class="w-full">
                            </div>
                            <div>
                                <label for="valorDiaria" class="slider-label"><span>Valor da diária (R$)</span><span class="slider-value" id="valorDiariaValue">150.00</span></label>
                                <input type="range" id="valorDiaria" min="50" max="300" value="150" step="1" class="w-full">
                            </div>
                            <div>
                                <label for="valorPedido" class="slider-label"><span>Valor por pedido (R$)</span><span class="slider-value" id="valorPedidoValue">4.00</span></label>
                                <input type="range" id="valorPedido" min="1" max="15" value="4" step="0.25" class="w-full">
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="font-semibold text-slate-700 border-b pb-2 mb-3">Custos Fixos Mensais</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="salariosEncargos" class="block text-sm font-medium text-slate-600 mb-1">Salários e encargos (R$)</label>
                                <input type="number" id="salariosEncargos" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="0,00" value="10000" min="0">
                            </div>
                            <div>
                                <label for="tecnologia" class="block text-sm font-medium text-slate-600 mb-1">Tecnologia (R$)</label>
                                <input type="number" id="tecnologia" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="0,00" value="5000" min="0">
                            </div>
                            <div>
                                <label for="operacional" class="block text-sm font-medium text-slate-600 mb-1">Operacional (R$)</label>
                                <input type="number" id="operacional" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="0,00" value="5000" min="0">
                            </div>
                            <div>
                                <label for="outros" class="block text-sm font-medium text-slate-600 mb-1">Outros (R$)</label>
                                <input type="number" id="outros" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-amber-500 focus:border-amber-500" placeholder="0,00" value="5000" min="0">
                            </div>
                        </div>
                    </div>
                            <div>
                                <label for="custoVariavelPedido" class="slider-label"><span>Custo variável / pedido (R$)</span><span class="slider-value" id="custoVariavelPedidoValue">1.25</span></label>
                                <input type="range" id="custoVariavelPedido" min="0" max="10" value="1.25" step="0.05" class="w-full">
                            </div>
                    
                    <div>
                        <h3 class="font-semibold text-slate-700 border-b pb-2 mb-3">Receita</h3>
                         <div class="space-y-4">
                            <div>
                                <label for="receitaMediaPedido" class="slider-label"><span>Receita média / pedido (R$)</span><span class="slider-value" id="receitaMediaPedidoValue">25.00</span></label>
                                <input type="range" id="receitaMediaPedido" min="5" max="100" value="25" step="0.5" class="w-full">
                            </div>
                        </div>
                    </div>

                    <div id="targetSection">
                        <h3 class="font-semibold text-slate-700 border-b pb-2 mb-3">Projeções para o Custo Alvo</h3>
                        <div class="space-y-4">
                             <div>
                                <label class="font-medium text-sm text-slate-600">Modelo de Custo Alvo</label>
                                <div class="flex items-center space-x-4 mt-2 text-sm">
                                    <label><input type="radio" name="targetModel" value="km" class="mr-1"> R$/km</label>
                                    <label><input type="radio" name="targetModel" value="diaria" checked class="mr-1"> R$/diária</label>
                                    <label><input type="radio" name="targetModel" value="pedido" class="mr-1"> R$/pedido</label>
                                </div>
                            </div>
                             <div>
                                <label id="targetLabel" for="custoAlvoSlider" class="slider-label"><span>Valor do Custo Alvo (R$)</span><span class="slider-value" id="custoAlvoSliderValue">150.00</span></label>
                                <input type="range" id="custoAlvoSlider" min="50" max="300" value="150" step="1" class="w-full">
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <section class="lg:col-span-2 space-y-8">
                 <div>
                    <h2 class="text-xl font-bold mb-1 text-slate-900">Resultados do Cenário Atual</h2>
                    <p class="text-sm text-slate-500 mb-4">Estes são os principais indicadores financeiros da sua operação, calculados com base nos parâmetros definidos. Eles são atualizados automaticamente a cada ajuste que você faz.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Receita Total Mensal</h4>
                            <p id="receitaTotal" class="text-2xl md:text-3xl font-bold text-amber-600 mt-1">R$ 0,00</p>
                            <p class="text-xs text-slate-400 mt-1">Volumetria total * Receita média por pedido</p>
                        </div>
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Custo Total Mensal</h4>
                            <p id="custoTotal" class="text-2xl md:text-3xl font-bold text-red-600 mt-1">R$ 0,00</p>
                            <p class="text-xs text-slate-400 mt-1">Custos Fixos + Custos Variáveis + Custos com Entregadores</p>
                        </div>
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Lucro / Prejuízo</h4>
                            <p id="lucroPrejuizo" class="text-2xl md:text-3xl font-bold mt-1">R$ 0,00</p>
                            <p class="text-xs text-slate-400 mt-1">Receita Total - Custo Total</p>
                        </div>
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Ponto de Equilíbrio (Break-Even)</h4>
                            <p id="breakEvenPoint" class="text-2xl md:text-3xl font-bold text-slate-700 mt-1">0 pedidos</p>
                            <p class="text-xs text-slate-400 mt-1">Pedidos necessários para cobrir todos os custos</p>
                        </div>
                         <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">CPO atual (Cost per Order)</h4>
                            <p id="custoPorPedido" class="text-2xl md:text-3xl font-bold text-slate-700 mt-1">R$ 0,00</p>
                            <p class="text-xs text-slate-400 mt-1">Custo Total Mensal / Volumetria total</p>
                        </div>
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Aumento de Receita Proj.</h4>
                            <p id="aumentoReceita" class="text-2xl md:text-3xl font-bold text-amber-600 mt-1">0%</p>
                            <p class="text-xs text-slate-400 mt-1">Aumento de receita para atingir o break-even</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-bold mb-1 text-slate-900">Projeções</h2>
                    <p class="text-sm text-slate-500 mb-4">Esses indicadores ajudam a projetar o impacto de mudanças operacionais no seu custo de entrega e na eficiência geral da sua operação.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Custo Diário por Entregador (Proj.)</h4>
                            <p id="custoDiarioEntregador" class="text-2xl md:text-3xl font-bold text-slate-700 mt-1">R$ 0,00</p>
                            <p class="text-xs text-slate-400 mt-1">Varia conforme o modelo de pagamento selecionado</p>
                        </div>
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Variação do CPO</h4>
                            <p id="variacaoCPO" class="text-2xl md:text-3xl font-bold mt-1">R$ 0,00</p>
                            <p class="text-xs text-slate-400 mt-1">CPO Atual - CPO Alvo</p>
                        </div>
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Entregadores para Vol. Atual</h4>
                            <p id="entregadoresAtuais" class="text-2xl md:text-3xl font-bold text-slate-700 mt-1">0</p>
                            <p class="text-xs text-slate-400 mt-1">Entregadores necessários para a volumetria mensal atual</p>
                        </div>
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Entregadores para o Break-Even</h4>
                            <p id="entregadoresBEP" class="text-2xl md:text-3xl font-bold text-slate-700 mt-1">N/A</p>
                            <p class="text-xs text-slate-400 mt-1">Entregadores necessarios para a volumetria projetada no break-even</p>
                        </div>
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Custo Alvo por Pedido (CPO)</h4>
                            <p id="custoAlvoPorPedido" class="text-2xl md:text-3xl font-bold text-slate-700 mt-1">R$ 0,00</p>
                            <p class="text-xs text-slate-400 mt-1">Baseado no valor e modelo de pagamento alvo</p>
                        </div>
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Tempo Médio da Rota</h4>
                            <p id="tempoMedioRota" class="text-2xl md:text-3xl font-bold text-slate-700 mt-1">0 min</p>
                            <p class="text-xs text-slate-400 mt-1">Tempo total de viagem + tempo de parada para todos os pedidos do dia</p>
                        </div>
                        <div class="kpi-card text-center">
                            <h4 class="text-sm font-medium text-slate-500">Média de km rodados / entregador</h4>
                            <p id="totalKm" class="text-2xl md:text-3xl font-bold text-slate-700 mt-1">0 km</p>
                            <p class="text-xs text-slate-400 mt-1">Pedidos por entregador / dia * Média de km / entrega</p>
                        </div>
                    </div>
                </div>
                
                <div class="kpi-card">
                     <h3 class="text-lg font-semibold text-slate-800 mb-1">Análise de Ponto de Equilíbrio e Lucratividade</h3>
                     <p class="text-sm text-slate-500 mb-4">O gráfico abaixo ilustra a relação entre receitas, custos e o volume de pedidos. O ponto onde a linha de receita cruza a de custos é o seu ponto de equilíbrio (break-even), a partir do qual a operação começa a gerar lucro.</p>
                    <div class="chart-container">
                        <canvas id="profitabilityChart"></canvas>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputs = {
                diasUteis: document.getElementById('diasUteis'),
                pedidosPorEntregador: document.getElementById('pedidosPorEntregador'),
                volumetriaTotal: document.getElementById('volumetriaTotal'),
                kmPorEntrega: document.getElementById('kmPorEntrega'),
                velocidadeMedia: document.getElementById('velocidadeMedia'),
                valorKm: document.getElementById('valorKm'),
                valorDiaria: document.getElementById('valorDiaria'),
                valorPedido: document.getElementById('valorPedido'),
                custoVariavelPedido: document.getElementById('custoVariavelPedido'),
                receitaMediaPedido: document.getElementById('receitaMediaPedido'),
                salariosEncargos: document.getElementById('salariosEncargos'),
                tecnologia: document.getElementById('tecnologia'),
                operacional: document.getElementById('operacional'),
                outros: document.getElementById('outros'),
                custoAlvoSlider: document.getElementById('custoAlvoSlider'),
                salarioMinimoDiarioSlider: document.getElementById('salarioMinimoDiarioSlider')
            };

            const valueSpans = {
                diasUteisValue: document.getElementById('diasUteisValue'),
                pedidosPorEntregadorValue: document.getElementById('pedidosPorEntregadorValue'),
                kmPorEntregaValue: document.getElementById('kmPorEntregaValue'),
                valorKmValue: document.getElementById('valorKmValue'),
                valorDiariaValue: document.getElementById('valorDiariaValue'),
                valorPedidoValue: document.getElementById('valorPedidoValue'),
                custoVariavelPedidoValue: document.getElementById('custoVariavelPedidoValue'),
                receitaMediaPedidoValue: document.getElementById('receitaMediaPedidoValue'),
                custoAlvoSliderValue: document.getElementById('custoAlvoSliderValue'),
                salarioMinimoDiarioSliderValue: document.getElementById('salarioMinimoDiarioSliderValue')
            };

            const outputs = {
                receitaTotal: document.getElementById('receitaTotal'),
                custoTotal: document.getElementById('custoTotal'),
                lucroPrejuizo: document.getElementById('lucroPrejuizo'),
                breakEvenPoint: document.getElementById('breakEvenPoint'),
                custoPorPedido: document.getElementById('custoPorPedido'),
                custoDiarioEntregador: document.getElementById('custoDiarioEntregador'),
                custoAlvoPorPedido: document.getElementById('custoAlvoPorPedido'),
                variacaoCPO: document.getElementById('variacaoCPO'),
                entregadoresAtuais: document.getElementById('entregadoresAtuais'),
                entregadoresBEP: document.getElementById('entregadoresBEP'),
                tempoMedioRota: document.getElementById('tempoMedioRota'),
                aumentoReceita: document.getElementById('aumentoReceita'),
                totalKm: document.getElementById('totalKm')
            };

            const paymentModelRadios = document.getElementsByName('paymentModel');
            const valorKmInput = document.getElementById('valorKm');
            const valorDiariaInput = document.getElementById('valorDiaria');
            const valorPedidoInput = document.getElementById('valorPedido');
            const paymentSection = document.getElementById('paymentSection');

            const targetModelRadios = document.getElementsByName('targetModel');
            const custoAlvoSlider = document.getElementById('custoAlvoSlider');
            const targetLabel = document.getElementById('targetLabel');
            const targetSection = document.getElementById('targetSection');

            function updateInputVisibility(modelRadios, inputs) {
                 const currentModel = document.querySelector(`input[name="${modelRadios[0].name}"]:checked`).value;
                 
                 inputs.forEach(input => {
                     const isVisible = input.id.toLowerCase().includes(currentModel);
                     input.closest('div').style.display = isVisible ? 'block' : 'none';
                 });
            }

            function updatePaymentInputsVisibility() {
                updateInputVisibility(paymentModelRadios, [valorKmInput, valorDiariaInput, valorPedidoInput]);
            }
            
            function updateTargetInputsVisibility() {
                const currentModel = document.querySelector('input[name="targetModel"]:checked').value;
                const ranges = {
                    'km': { min: 0.1, max: 10, step: 0.1, label: 'Valor do Custo Alvo (R$/km)' },
                    'diaria': { min: 50, max: 300, step: 1, label: 'Valor do Custo Alvo (R$/diária)' },
                    'pedido': { min: 1, max: 15, step: 0.25, label: 'Valor do Custo Alvo (R$/pedido)' }
                };
                const range = ranges[currentModel];
                custoAlvoSlider.min = range.min;
                custoAlvoSlider.max = range.max;
                custoAlvoSlider.step = range.step;
                custoAlvoSlider.value = range.min; 
                targetLabel.querySelector('span:first-child').textContent = range.label;
            }

            function updateAllInputStates() {
                const minWage = parseFloat(inputs.salarioMinimoDiarioSlider.value);
                const isDisabled = minWage > 0;

                paymentSection.classList.toggle('disabled-overlay', isDisabled);
                targetSection.classList.toggle('disabled-overlay', isDisabled);

                const allPaymentInputs = [
                    ...Array.from(paymentModelRadios),
                    valorKmInput,
                    valorDiariaInput,
                    valorPedidoInput
                ];
                allPaymentInputs.forEach(input => input.disabled = isDisabled);

                const allTargetInputs = [
                    ...Array.from(targetModelRadios),
                    custoAlvoSlider
                ];
                allTargetInputs.forEach(input => input.disabled = isDisabled);
            }

            updatePaymentInputsVisibility();
            updateTargetInputsVisibility();
            
            const formatCurrency = (value) => {
                if (isNaN(value) || !isFinite(value)) return 'R$ 0,00';
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            };

            const formatNumber = (value) => {
                 if (isNaN(value) || !isFinite(value)) return 'N/A';
                 return Math.ceil(value).toLocaleString('pt-BR');
            };

            const ctx = document.getElementById('profitabilityChart').getContext('2d');
            const profitabilityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Receita Total',
                            data: [],
                            borderColor: '#16a34a',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                        },
                        {
                            label: 'Custo Total',
                            data: [],
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                        },
                        {
                            label: 'Custo Alvo por Pedido',
                            data: [],
                            borderColor: '#2563eb',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            borderWidth: 2,
                            fill: false,
                            tension: 0,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value, index, values) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        },
                        x: {
                           ticks: {
                                maxRotation: 0,
                                minRotation: 0
                           }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            function calculateAndRender() {
                const vals = {};
                for (const key in inputs) {
                     vals[key] = parseFloat(inputs[key].value);
                }
                const currentPaymentModel = document.querySelector('input[name="paymentModel"]:checked').value;
                
                const custoFixoBase = vals.salariosEncargos + vals.tecnologia + vals.operacional + vals.outros;
                const volumetriaTotal = vals.volumetriaTotal;
                const dailyCapacity = vals.pedidosPorEntregador * vals.diasUteis;
                
                const entregadoresNecessariosAtualmente = Math.ceil(volumetriaTotal / dailyCapacity);
                const receitaTotal = volumetriaTotal * vals.receitaMediaPedido;
                
                let custoMaoDeObra = 0;
                let custoEntrega = 0;
                let custoDiarioEntregador = 0;
                let variavelCustoMotoboy = 0;

                // New logic based on the minimum daily wage slider
                if (vals.salarioMinimoDiarioSlider > 0) {
                    custoDiarioEntregador = vals.salarioMinimoDiarioSlider;
                    custoMaoDeObra = entregadoresNecessariosAtualmente * vals.diasUteis * custoDiarioEntregador;
                    variavelCustoMotoboy = vals.salarioMinimoDiarioSlider / vals.pedidosPorEntregador;
                } else {
                    if (currentPaymentModel === 'km') {
                        custoEntrega = vals.kmPorEntrega * vals.valorKm;
                        custoMaoDeObra = volumetriaTotal * custoEntrega;
                        custoDiarioEntregador = vals.pedidosPorEntregador * vals.kmPorEntrega * vals.valorKm;
                        variavelCustoMotoboy = custoEntrega;
                    } else if (currentPaymentModel === 'diaria') {
                        custoEntrega = vals.pedidosPorEntregador > 0 ? vals.valorDiaria / vals.pedidosPorEntregador : 0;
                        custoMaoDeObra = entregadoresNecessariosAtualmente * vals.diasUteis * vals.valorDiaria;
                        custoDiarioEntregador = vals.valorDiaria;
                        variavelCustoMotoboy = custoEntrega;
                    } else if (currentPaymentModel === 'pedido') {
                        custoEntrega = vals.valorPedido;
                        custoMaoDeObra = volumetriaTotal * custoEntrega;
                        custoDiarioEntregador = vals.valorPedido * vals.pedidosPorEntregador;
                        variavelCustoMotoboy = custoEntrega;
                    }
                }

                const custoVariavelTotal = volumetriaTotal * vals.custoVariavelPedido;
                const custoTotal = custoFixoBase + custoVariavelTotal + custoMaoDeObra;
                const lucroPrejuizo = receitaTotal - custoTotal;
                const custoPorPedido = volumetriaTotal > 0 ? custoTotal / volumetriaTotal : 0;
                const receitaPorPedido = vals.receitaMediaPedido;
                
                let custoAlvoPorPedido = 0;
                if (vals.salarioMinimoDiarioSlider > 0) {
                     custoAlvoPorPedido = vals.salarioMinimoDiarioSlider / vals.pedidosPorEntregador;
                } else {
                     if (document.querySelector('input[name="targetModel"]:checked').value === 'km') {
                        custoAlvoPorPedido = vals.custoAlvoSlider * vals.kmPorEntrega;
                     } else if (document.querySelector('input[name="targetModel"]:checked').value === 'diaria') {
                         custoAlvoPorPedido = vals.custoAlvoSlider / vals.pedidosPorEntregador;
                     } else if (document.querySelector('input[name="targetModel"]:checked').value === 'pedido') {
                         custoAlvoPorPedido = vals.custoAlvoSlider;
                     }
                }
                
                const variacaoCPO = custoPorPedido - custoAlvoPorPedido;
                
                // Cálculo do Ponto de Equilíbrio (Break-Even)
                const totalVariableCostPerOrder = vals.custoVariavelPedido + variavelCustoMotoboy;
                const unitMargin = receitaPorPedido - totalVariableCostPerOrder;
                let breakEvenPoint = "Não há BEP";
                let entregadoresParaBEP = "N/A";

                if (unitMargin > 0) {
                    breakEvenPoint = Math.ceil(custoFixoBase / unitMargin);
                    const dailyCapacityBEP = vals.pedidosPorEntregador * vals.diasUteis;
                    entregadoresParaBEP = Math.ceil(breakEvenPoint / dailyCapacityBEP);
                } else {
                    breakEvenPoint = "Não há BEP"
                }

                let aumentoPercentualReceita = "N/A";
                if (entregadoresNecessariosAtualmente > 0 && typeof entregadoresParaBEP === 'number' && entregadoresParaBEP > 0) {
                    aumentoPercentualReceita = ((entregadoresParaBEP / entregadoresNecessariosAtualmente) - 1) * 100;
                }

                // Cálculo do Tempo Médio da Rota
                let tempoMedioRota = 0;
                let tempoViagemMin = 0;
                let tempoParadaMin = 0;
                if (vals.velocidadeMedia > 0) {
                    const totalKmDiario = vals.kmPorEntrega * vals.pedidosPorEntregador;
                    tempoViagemMin = (totalKmDiario / vals.velocidadeMedia) * 60;
                    tempoParadaMin = vals.pedidosPorEntregador * 5; // Assumindo 5 minutos de parada por pedido
                    tempoMedioRota = tempoViagemMin + tempoParadaMin;
                }
                
                let tempoFormatado = "N/A";
                if (!isNaN(tempoMedioRota) && tempoMedioRota > 0) {
                    if (tempoMedioRota >= 60) {
                        const horas = Math.floor(tempoMedioRota / 60);
                        const minutos = Math.round(tempoMedioRota % 60);
                        tempoFormatado = `${horas}h ${minutos}min`;
                    } else {
                        tempoFormatado = `${tempoMedioRota.toFixed(0)} min`;
                    }
                }

                // Cálculo da quantidade total de km rodados POR ENTREGADOR
                const totalKmRodadosPorEntregador = vals.kmPorEntrega * vals.pedidosPorEntregador;

                
                outputs.receitaTotal.textContent = formatCurrency(receitaTotal);
                outputs.custoTotal.textContent = formatCurrency(custoTotal);
                outputs.lucroPrejuizo.textContent = formatCurrency(lucroPrejuizo);
                outputs.lucroPrejuizo.classList.toggle('text-green-600', lucroPrejuizo >= 0);
                outputs.lucroPrejuizo.classList.toggle('text-red-600', lucroPrejuizo < 0);
                outputs.breakEvenPoint.textContent = typeof breakEvenPoint === 'number' ? formatNumber(breakEvenPoint) + ' pedidos' : breakEvenPoint;
                outputs.custoPorPedido.textContent = formatCurrency(custoPorPedido);
                outputs.custoDiarioEntregador.textContent = formatCurrency(custoDiarioEntregador);
                outputs.custoAlvoPorPedido.textContent = formatCurrency(custoAlvoPorPedido);
                outputs.variacaoCPO.textContent = formatCurrency(variacaoCPO);
                outputs.variacaoCPO.classList.toggle('text-green-600', variacaoCPO <= 0);
                outputs.variacaoCPO.classList.toggle('text-red-600', variacaoCPO > 0);
                
                outputs.entregadoresAtuais.textContent = formatNumber(entregadoresNecessariosAtualmente);
                outputs.entregadoresBEP.textContent = typeof entregadoresParaBEP === 'number' ? formatNumber(entregadoresParaBEP) : entregadoresParaBEP;
                outputs.aumentoReceita.textContent = typeof aumentoPercentualReceita === 'number' ? aumentoPercentualReceita.toFixed(2) + '%' : aumentoPercentualReceita;
                outputs.tempoMedioRota.textContent = tempoFormatado;
                outputs.totalKm.textContent = isNaN(totalKmRodadosPorEntregador) ? 'N/A' : `${totalKmRodadosPorEntregador.toLocaleString('pt-BR')} km`;


                updateChart(volumetriaTotal, receitaPorPedido, custoFixoBase, totalVariableCostPerOrder, custoAlvoPorPedido);
            }
            
            function updateChart(currentVolume, receitaUnitaria, custoFixoBase, totalVariableCostPerOrder, custoAlvoPorPedido) {
                const labels = [];
                const receitaData = [];
                const custoData = [];
                const custoAlvoData = [];

                const maxVolume = Math.max(currentVolume * 2, 1000);
                const step = Math.ceil(maxVolume / 20);
                
                for (let vol = 0; vol <= maxVolume; vol += step) {
                    labels.push(vol);
                    const receita = vol * receitaUnitaria;
                    
                    const custo = custoFixoBase + (vol * totalVariableCostPerOrder);

                    receitaData.push(receita);
                    custoData.push(custo);
                    custoAlvoData.push(custoAlvoPorPedido * vol);
                }

                profitabilityChart.data.labels = labels;
                profitabilityChart.data.datasets[0].data = receitaData;
                profitabilityChart.data.datasets[1].data = custoData;
                profitabilityChart.data.datasets[2].data = custoAlvoData;
                profitabilityChart.update();
            }

            const allInputs = document.querySelectorAll('#input-form input');
            allInputs.forEach(input => {
                input.addEventListener('input', () => {
                     if (input.type === 'range') {
                        const valueSpan = document.getElementById(input.id + 'Value');
                        if (valueSpan) {
                             if (['valorKm', 'valorDiaria', 'valorPedido', 'custoVariavelPedido', 'receitaMediaPedido', 'custoAlvoSlider', 'salarioMinimoDiarioSlider'].includes(input.id)) {
                                 valueSpan.textContent = parseFloat(input.value).toFixed(2);
                             } else {
                                 valueSpan.textContent = input.value;
                             }
                        }
                    }
                    updateAllInputStates();
                    calculateAndRender();
                });
            });
            
            paymentModelRadios.forEach(radio => radio.addEventListener('change', () => {
                updatePaymentInputsVisibility();
                calculateAndRender();
            }));

            targetModelRadios.forEach(radio => radio.addEventListener('change', () => {
                updateTargetInputsVisibility();
                calculateAndRender();
            }));

            updateAllInputStates();
            calculateAndRender();
        });
    </script>
</body>
</html>
